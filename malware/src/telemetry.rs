//! Recolección de telemetría del entorno para validar precondiciones del laboratorio.

use sysinfo::{CpuRefreshKind, MemoryRefreshKind, RefreshKind, System};

#[allow(dead_code)]
pub fn audit_system_resources() -> SystemSnapshot {
    // Refresca CPU y memoria para obtener métricas recientes.
    let mut sys = System::new_with_specifics(
        RefreshKind::new()
            .with_cpu(CpuRefreshKind::everything())
            .with_memory(MemoryRefreshKind::everything()),
    );
    sys.refresh_memory();
    sys.refresh_cpu();

    let total_mem = sys.total_memory();
    let avail_mem = sys.available_memory();
    let cpu_logical = sys.cpus().len() as u64;
    let avg_cpu_load: f32 = if !sys.cpus().is_empty() {
        sys.cpus().iter().map(|c| c.cpu_usage()).sum::<f32>() / sys.cpus().len() as f32
    } else {
        0.0
    };

    // Umbrales mínimos para el laboratorio académico.
    const MIN_RAM_BYTES: u64 = 4 * 1024 * 1024 * 1024; // 4 GiB
    const MIN_CPU_LOGICAL: u64 = 2;

    println!(
        "[telemetry] RAM total: {} MB | disponible: {} MB",
        total_mem / 1024 / 1024,
        avail_mem / 1024 / 1024
    );
    println!(
        "[telemetry] CPUs lógicas: {} | carga media: {:.2}%",
        cpu_logical, avg_cpu_load
    );

    let ram_ok = total_mem >= MIN_RAM_BYTES;
    let cpu_ok = cpu_logical >= MIN_CPU_LOGICAL;
    if !ram_ok || !cpu_ok {
        println!(
            "[telemetry] Advertencia: umbrales mínimos no cumplidos (RAM OK: {}, CPU OK: {}).",
            ram_ok, cpu_ok
        );
    } else {
        println!("[telemetry] Requisitos mínimos cumplidos para la prueba.");
    }

    // Heurística simple de virtualización: usar nombre de host y marca de sistema operativo.
    let host_name = System::host_name().unwrap_or_else(|| "desconocido".to_string());
    let os_name = System::name().unwrap_or_else(|| "SO_desconocido".to_string());
    let is_probably_vm = host_name.to_uppercase().contains("VBOX")
        || host_name.to_uppercase().contains("VM")
        || os_name.to_uppercase().contains("HYPER-V");
    println!(
        "[telemetry] Host: {} | SO: {} | Entorno virtualizado (heurístico): {}",
        host_name, os_name, is_probably_vm
    );

    SystemSnapshot {
        total_memory: total_mem,
        available_memory: avail_mem,
        cpu_logical,
        avg_cpu_load,
        host_name,
        os_name,
        is_probably_vm,
    }
}

/// Estructura ligera para transportar telemetría entre módulos.
#[derive(Debug, Clone)]
pub struct SystemSnapshot {
    pub total_memory: u64,
    pub available_memory: u64,
    pub cpu_logical: u64,
    pub avg_cpu_load: f32,
    pub host_name: String,
    pub os_name: String,
    pub is_probably_vm: bool,
}
